#!/bin/bash
# =============================================================================
# Health Check - Verifies server is running and responsive
# =============================================================================

# Source common functions
source /opt/palworld/scripts/common 2>/dev/null || true

# Check if server process is running
if ! pgrep -f "PalServer-Linux-Shipping" > /dev/null 2>&1; then
    echo "UNHEALTHY: Server process not running"
    exit 1
fi

# Check if server is accepting connections by probing the query port
SERVER_PORT="${SERVER_PORT:-8211}"
QUERY_PORT="27015"

# Use netcat to check if port is open (basic check)
if command -v nc &> /dev/null; then
    if ! nc -z -u -w 2 127.0.0.1 "${QUERY_PORT}" 2>/dev/null; then
        # UDP check might fail even if server is up, so just warn
        echo "WARNING: Query port ${QUERY_PORT} may not be responding"
    fi
fi

# Check if we've seen the server ready message recently
LOG_FILE="/var/log/palworld/palworld-server.log"
if [[ -f "${LOG_FILE}" ]]; then
    # Look for any indication the server started successfully
    if grep -q "LogNet:" "${LOG_FILE}" 2>/dev/null; then
        echo "HEALTHY: Server is running and network is initialized"
        exit 0
    fi
fi

# Basic check passed - process is running
echo "HEALTHY: Server process is running (PID: $(pgrep -f PalServer-Linux-Shipping))"
exit 0
